<!DOCTYPE HTML>
<html lang="en">
<head>
	<title>The QT Admin</title>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	
<style type="text/css">
	@import url(http://reset5.googlecode.com/hg/reset.min.css);
	 
	body{
		color: #242323;
	}
	a{}
		a:hover{}
	ul{list-style-type: none;}
	
	h3{font-size: 1.3em;}
	
	#container{
		padding: 20px;
	}
	
	header{
		margin-bottom: 30px;
		font-size: 1.2em;
	}

	#quote-admin{
		display: none;
	}

	section{
		overflow: hidden;
		padding: 20px 0;
		border-bottom: 3px solid #555;
	}
	
		#quote-input form{
			float: left;
			width: 600px;
		}

		#author-input form{
			width: 100%;
		}
			#author-input form fieldset{
				overflow: hidden;
				float: left;
				width: 600px;
			}
				#author-input #design input{float: left;}
	
	input, textarea{
		display: block;
		margin-bottom: 20px;
		padding: 5px;
	}
	
	#schedule{}
		#schedule .year{overflow: hidden; display: block;}
		#schedule .month{overflow: hidden; display: block; float: left; width: 300px; height: 200px; margin-right: 40px;}
		#schedule p{display: block; float: left; padding: 10px; width: 20px; height: 20px; text-align: center;}
		
		#schedule .no-quote{color: #ff0000;}
		#schedule .quote{color: #00ff00;}
		#schedule .today{background: #aaa;}
	
</style>

<script type="text/javascript">
	var monthNames = [ "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December" ];

	// INIT
	$(document).ready(function(){
		// quotesomefetch link listener
		$("form#fetch-url input[type='submit']").click(function(event){
			fetchQuotesome($("form input[type='url']").val());
		});
		
		// add-quote db link listener
		$("form#add-quote").submit(addQuote);

		// update db link listener
		$("form#add-author").submit(addAuthor);
		
		// fetch schedule link listener
		$("a#fetch-schedule").click(fetchSchedule);
		
		// fetch authors link listener
		$("a#fetch-authors").click(fetchAuthors);

		// admin menu toggling
		$("a#admin-switch").click(function(event){
			$('#container>div').toggle();
		});


		// get current schedule
		fetchSchedule();

	});

	// add quote to DB
	function addQuote(){
		console.log("posting new quote to server...");
		var data = {
			author:		$('#author').val(),
			authorID:	$('#author-id').val(),
			quoteUrl:	$('#quote-url').val(),
			quoteText:	$('#quote-text').val(),
			pubDate:	$('#pubdate').val(),
		};
		
		console.log(data);

		$.ajax({
		  type: "POST",
		  url: '/admin-add-quote',
		  data: JSON.stringify(data),
		  success: fetchSchedule
		});
	}

	// add author to DB
	function addAuthor(){
		console.log("posting new author to server...");

		var data = {};
		$('#author-input fieldset input').each(function(index){
			if($(this).val() && $(this).val() != ''){
				data[$(this).attr('name')] = ''+$(this).val();
			}
		});

		console.log(data);

		$.ajax({
		  type: "POST",
		  url: '/admin-add-author',
		  data: JSON.stringify(data),
		  success: fetchAuthors
		});
	}

	// fetch authors function
	function fetchAuthors(){
		console.log("fetching authors...");
			
		$.ajax({
			type: "POST",
			url: '/admin-fetch-authors',
			success: listAuthors
		});

		function listAuthors(data){
			console.log('got authors list back from node:');
			console.log(data);

			$.each($.parseJSON(data), function(index, value){
				$('#author-output').append('<p>'+value.name+'</p>');
			});
		}
	}

	// fetch schedule function
	function fetchSchedule(){
		console.log("fetching schedule...");
		
		$.ajax({
			type: "POST",
			url: '/admin-fetch-schedule',
			success: displaySchedule
		});
		
		function displaySchedule(data){
			console.log('got schedule back from node:');
			console.log(data);
			
			$('#schedule').empty();
			var json = $.parseJSON(data);
			var now = new Date();
			var endDate = new Date(now.getFullYear(), now.getMonth()+2, 1);
			
			// display these 3 months
			for(var startDate = new Date(now.getFullYear(), now.getMonth()-1, 1); startDate < endDate; startDate.setDate(startDate.getDate()+1)){
				var year = startDate.getFullYear();
				var month = startDate.getMonth();
				var day = startDate.getDate();
				
				if($('#schedule #y'+year).length == 0)
					$('#schedule').append('<div class="year" id="y'+year+'"><h3>'+year+'<h3></div>');
				
				if($('#schedule #y'+year+' #m'+month).length == 0)
					$('#schedule #y'+year).append('<div class="month" id="m'+month+'"><h4>'+monthNames[month]+'<h4></div>');
				
				if(json[year] && (json[year])[month] && ((json[year])[month])[day])
					$('#schedule #y'+year+' #m'+month).append('<p class="quote" id="d'+day+'-'+month+'">'+day+'</p>');
				else
					$('#schedule #y'+year+' #m'+month).append('<p class="no-quote" id="d'+day+'-'+month+'">'+day+'</p>');
				
			}
			
			$('#schedule #y'+now.getFullYear()+' #m'+now.getMonth()+' #d'+now.getDate()+'-'+now.getMonth()).addClass('today');
		}
	}

	// fetch quote detail from quotesome
	function fetchQuotesome(url){
		console.log("fetching "+$("form input[type='url']").val()+"...");
		var ExternalURL = url; // This address must not contain any leading 'http://'
		var freeDaySet = false;

		var QueryURL = "http://anyorigin.com/get?url=" + ExternalURL + "&callback=?";
		$.getJSON(QueryURL, function(data){
			if (data && data != null && typeof data == 'object' && data.contents && data.contents != null && typeof data.contents == 'string'){
				data = data.contents.replace(/<script[^>]*>[sS]*?<\/script>/gi, '');
				if (data.length > 0){
					$('#author').val($('.row .author', data).html());
					$('#author-id').val((($('.author', data).html()).toLowerCase()).replace(/ /g,'_'));
					$('#quote-url').val(url);
					$('#quote-text').val($('.quote-block-quote-text', data).html());
					var now = new Date();
					if(!freeDaySet)
						$('#pubdate').val(now.getFullYear()+'-'+(now.getMonth()<9 ? '0'+(now.getMonth()+1) : now.getMonth()+1)+'-'+(now.getDate()<10 ? '0'+now.getDate() : now.getDate()));
				}
			}
		});
		
					
		$.ajax({
			type: "POST",
			url: '/admin-fetch-schedule',
			success: updateDate
		});
		
		function updateDate(data){
			console.log('got something back from node: '+data);
				
			var json = $.parseJSON(data);
			var now = new Date();
			var safety = 0;
			while(true){
				if(!((json[now.getFullYear()]) && ((json[now.getFullYear()])[now.getMonth()]) && (((json[now.getFullYear()])[now.getMonth()])[now.getDate()]))){
					$('#pubdate').val(now.getFullYear()+'-'+(now.getMonth()<9 ? '0'+(now.getMonth()+1) : now.getMonth()+1)+'-'+(now.getDate()<10 ? '0'+now.getDate() : now.getDate()));
					freeDaySet = true;
					break;
				}
				now.setDate(now.getDate()+1);
				safety++;
				if(safety == 60) break;
			}
		}
	}
	
</script>

</head>

<body>
	<div id="container">
		<header>
			<h1>ADMIN (<a id="admin-switch" href="#">switch admin panel</a>)</h1>
		</header>
		
		<div id="quote-admin">
			<h2>Quote admin</h2>
			<section id="quote-input">
				<form id="fetch-url" onsubmit="return false;">
					<input type="url" name="source-url" placeholder="fetch from url" size="100" autofocus required value="http://quoteso.me/q/226937" />
					
					<input type="submit" value="fetch url" />
				</form>
			
				<form id="add-quote" onsubmit="return false;">
					<input id="author" name="author" type="text" size="60" placeholder="author" />
					<input id="author-id" name="author-id" type="text" size="60" placeholder="authorID" />
					<input id="quote-url" name="quote-url" type="url" size="60" placeholder="quote url" />
					<textarea id="quote-text" name="quote-text" rows="5" cols="60" placeholder="quote text"></textarea>
					<input id="pubdate" name="pubdate" type="date"/>
					<input id="block-font-size" name="block-font-size" type="text" size="10" placeholder="block font size (48px)" />
					
					<input type="submit" value="add quote" />
				</form>
			</section>
			
			<section id="quote-output">
				<a id="fetch-schedule" href="#">FETCH SCHEDULE</a>
				
				<article id="schedule">
				</article>
			</section>
		</div>

		<div id="author-admin">
			<h2>Author admin</h2>
			<section id="author-input">
				<form id="add-author" onsubmit="return false;">
					<fieldset id="data">
						<legend>Data</legend>
						<input id="author-id" name="authorID" type="text" size="60" placeholder="authorID" required />
						<input id="author-name" name="name" type="text" size="60" placeholder="author" />
						<input id="author-wiki" name="wikipediaRef" type="text" size="60" placeholder="wikipediaID" />
						<input id="author-quotesome" name="quotesomeUrl" type="url" size="100" placeholder="quotesome url" />
					</fieldset>

					<fieldset id="design">
						<legend>Design</legend>
						<input id="photo-url" name="photoPath" type="url" size="100" placeholder="photo url" />
						<input id="photo-width" name="photoWidth" type="text" size="40" placeholder="photo width (0)" />
						<input id="photo-height" name="photoHeight" type="text" size="40" placeholder="photo height (0)" />
						<input id="position-left" name="positionLeft" type="text" size="40" placeholder="position left (auto, use %)" />
						<input id="position-right" name="positionRight" type="text" size="40" placeholder="position right (auto, use %)" />
						<input id="position-top" name="positionTop" type="text" size="40" placeholder="position top (auto, use %)" />
						<input id="position-bottom" name="positionBottom" type="text" size="40" placeholder="position bottom (auto, use %)" />
						<input id="block-width" name="blockWidth" type="text" size="40" placeholder="block width (35%)" />
						<input id="block-font-color" name="blockFontColor" type="text" size="40" placeholder="block font color (#000)" />
						<input id="block-background-color" name="blockBackgroundColor" type="text" size="40" placeholder="block background color (none)" />
						<input id="bars-background-color" name="barsBackgroundColor" type="text" size="40" placeholder="bars background color (#fff)" />
						<input id="direction-slide" name="directionSlide" type="text" size="40" placeholder="direction slide (center)" />
					</fieldset>

					<input type="submit" value="add author" />
					
				</form>
			</section>

			<section id="author-output">
				<a id="fetch-authors" href="#">FETCH AUTHORS</a>

			</section>
		</div>

		<footer>
		</footer>
	</div>
</body>

</html>
